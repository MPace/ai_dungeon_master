<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Dungeon Master</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="static/css/style.css">
    <!-- Google Font for Fantasy Theme -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lora:wght@400;500&display=swap" rel="stylesheet">
</head>
<body class="bg-dark">
    <div class="container-fluid px-4 py-3">
        <!-- Header -->
        <header class="text-center mb-3">
            <h1 class="display-4 text-light">AI Dungeon Master</h1>
            <p class="lead text-light">Your interactive D&D 5e experience</p>
        </header>
        
        <!-- Main content -->
        <div class="row">
            <!-- Game chat area - Now wider -->
            <div class="col-md-9 mb-4">
                <div class="card shadow h-100 d-flex flex-column border-0">
                    <div class="card-header bg-dark text-light border-bottom border-secondary">
                        <h5 class="mb-0"><i class="bi bi-book me-2"></i>Adventure Log</h5>
                    </div>
                    <div class="card-body chat-window" id="chatWindow">
                        <!-- Messages will appear here -->
                        <div class="message dm-message">
                            <p>Welcome, adventurer! I am your AI Dungeon Master. Would you like to start a new adventure or continue an existing one?</p>
                        </div>
                    </div>
                    <div class="card-footer bg-dark border-top border-secondary">
                        <div class="input-group">
                            <input type="text" id="playerInput" class="form-control bg-dark text-light border-secondary" placeholder="What would you like to do?">
                            <button class="btn btn-outline-light" id="sendButton">
                                <i class="bi bi-send"></i> Send
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar for character info and tools - Now narrower -->
            <div class="col-md-3 mb-4">
                <div class="card shadow mb-4 border-0">
                    <div class="card-header bg-dark text-light border-bottom border-secondary">
                        <h5 class="mb-0"><i class="bi bi-person me-2"></i>Character Sheet</h5>
                    </div>
                    <div class="card-body" id="characterSheet">
                        <p class="text-center text-muted">No character loaded yet</p>
                    </div>
                </div>
                
                <div class="card shadow border-0">
                    <div class="card-header bg-dark text-light border-bottom border-secondary">
                        <h5 class="mb-0"><i class="bi bi-dice-6 me-2"></i>Dice Roller</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" data-dice="d20">Roll d20</button>
                            <div class="btn-group">
                                <button class="btn btn-outline-secondary" data-dice="d4">d4</button>
                                <button class="btn btn-outline-secondary" data-dice="d6">d6</button>
                                <button class="btn btn-outline-secondary" data-dice="d8">d8</button>
                                <button class="btn btn-outline-secondary" data-dice="d10">d10</button>
                                <button class="btn btn-outline-secondary" data-dice="d12">d12</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="static/js/main.js"></script>
    
    <!-- Inline script for fallback functionality -->
    <script>
    // Fallback script in case the external JavaScript file doesn't load
    console.log('Inline script executing');
    
    // Check if the main script has already initialized the handlers
    setTimeout(function() {
        // Elements
        const chatWindow = document.getElementById('chatWindow');
        const playerInput = document.getElementById('playerInput');
        const sendButton = document.getElementById('sendButton');
        
        // Check if click handler is already attached
        if (sendButton && !sendButton._hasClickHandler) {
            console.log('Adding fallback click handler to send button');
            sendButton._hasClickHandler = true;
            
            sendButton.addEventListener('click', function() {
                console.log('Send button clicked (fallback handler)');
                const message = playerInput.value.trim();
                
                if (message) {
                    // Create and add player message element
                    const playerMsgDiv = document.createElement('div');
                    playerMsgDiv.classList.add('message', 'player-message');
                    playerMsgDiv.innerHTML = '<p>' + message + '</p>';
                    chatWindow.appendChild(playerMsgDiv);
                    
                    // Clear input
                    playerInput.value = '';
                    
                    // Scroll to bottom
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                    
                    // Try to fetch from API first, fall back if it fails
                    const apiErrorDiv = document.createElement('div');
                    apiErrorDiv.classList.add('message', 'dm-message');
                    apiErrorDiv.innerHTML = '<p>Testing API connection...</p>';
                    chatWindow.appendChild(apiErrorDiv);
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                    
                    // Try to call the test API endpoint
                    fetch('/test-api')
                        .then(response => {
                            if (!response.ok) throw new Error('API test failed with status: ' + response.status);
                            return response.json();
                        })
                        .then(data => {
                            // API is working, update message
                            apiErrorDiv.innerHTML = '<p>API connection successful! However, the main API call failed. Check browser console for details.</p>';
                            console.log('API test successful:', data);
                            
                            // Try the actual message API
                            return fetch('/api/send-message', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    message: message,
                                    session_id: null
                                })
                            });
                        })
                        .then(response => {
                            if (!response.ok) throw new Error('Message API failed with status: ' + response.status);
                            return response.json();
                        })
                        .then(data => {
                            // If we get here, API worked after all!
                            apiErrorDiv.innerHTML = '<p>' + data.response + '</p>';
                        })
                        .catch(error => {
                            // Update with error details
                            apiErrorDiv.innerHTML = '<p>API Error: ' + error.message + 
                                '. Visit /api-test to debug API issues. Falling back to default response.</p>';
                            console.error('API error in fallback handler:', error);
                            
                            // Add the fallback response after error message
                            setTimeout(function() {
                                const dmMsgDiv = document.createElement('div');
                                dmMsgDiv.classList.add('message', 'dm-message');
                                dmMsgDiv.innerHTML = '<p>The Dungeon Master acknowledges your action. (Fallback response)</p>';
                                chatWindow.appendChild(dmMsgDiv);
                                chatWindow.scrollTop = chatWindow.scrollHeight;
                            }, 1000);
                        });
                }
            });
        }
        
        // Add Enter key handler to input if not already present
        if (playerInput && !playerInput._hasKeyHandler) {
            console.log('Adding fallback keypress handler to input');
            playerInput._hasKeyHandler = true;
            
            playerInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && sendButton) {
                    console.log('Enter key pressed (fallback handler)');
                    sendButton.click();
                }
            });
        }
    }, 1000); // Wait 1 second to check if main script loaded
    </script>
</body>
</html>